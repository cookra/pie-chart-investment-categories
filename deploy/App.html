<!DOCTYPE html>
<html>
<head>
    <title>Investement Categories</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",categories:[],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long depending on your data..."}),this._myMask.show(),this.loadCategories().then({success:function(){this.makeComponents()},scope:this})},loadCategories:function(){return Rally.data.ModelFactory.getModel({type:"PortfolioItem",success:function(model){model.getField("InvestmentCategory").getAllowedValueStore().load({callback:function(records){this.categories=_.rest(_.invoke(records,"get","StringValue"))},scope:this})},scope:this})},makeComponents:function(){console.log("categories",this.categories),this.add({xtype:"rallyreleasecombobox",itemId:"releaseComboBox",fieldLabel:"Filter by Release:",context:this.getContext().getDataContext(),listeners:{ready:this.getFeaturesInRelease,select:this.getFeaturesInRelease,scope:this}}),this.add({layout:{type:"hbox",align:"stretch"},items:[{xtype:"container",itemId:"chartContainer",flex:1},{xtype:"container",itemId:"gridContainer",flex:1}]})},getFeaturesInRelease:function(release){var releaseRef=release.getValue();console.log("release",releaseRef),console.log(this.getContext().getDataContext());var store=Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/feature",autoLoad:!0,limit:1/0,fetch:["FormattedID","Name","Project","InvestmentCategory","Parent"],filters:[{property:"Release",value:releaseRef}],listeners:{load:function(store,records){this.processResults(store,records)},scope:this},context:this.getContext().getDataContext()})},processResults:function(store,records){var app=this,countByCategory={},piData=[],recordsGroupedByCategory=[];_.each(records,function(record){console.log("FormattedID: ",record.get("FormattedID"),"Name",record.get("Name"),"InvestmentCategory:",record.get("InvestmentCategory"))}),_.each(this.categories,function(category){countByCategory[category]=0,recordsGroupedByCategory.push({category:category,records:[]})}),_.each(records,function(record){if(category=record.get("InvestmentCategory"),"None"!==category){countByCategory[category]++;var obj=_.find(recordsGroupedByCategory,function(o){return o.category===category});obj.records.push(record)}}),console.log("recordsGroupedByCategory",recordsGroupedByCategory),_.each(this.categories,function(category){var color=this.pickColor(category);piData.push({name:category,y:countByCategory[category],color:color,foo:"ok"})},this),this.down("#piGrid")&&this.down("#gridContainer").remove("piGrid"),this.down("#piByCategory")&&this.down("#chartContainer").remove("piByCategory"),this._myMask.hide(),this.down("#chartContainer").add({xtype:"rallychart",height:400,storeType:"Rally.data.wsapi.Store",store:store,itemId:"piByCategory",chartConfig:{chart:{},title:{text:"Features By Investment Category",align:"center"},tooltip:{formatter:function(){return this.point.name+": <b>"+Highcharts.numberFormat(this.percentage,1)+"%</b><br />Count: "+this.point.y}},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,color:"#000000",connectorColor:"#000000"}}}},chartData:{categories:category,series:[{type:"pie",name:"Investement Categories",data:piData,point:{events:{click:function(event){var selectedRecords=_.find(recordsGroupedByCategory,function(o){return o.category===this.name},this);app.makeGrid(selectedRecords)}}}}]}}),this.down("#piByCategory")._unmask()},pickColor:function(category){var color="";switch(category){case"Architecture":color="#228B22";break;case"Sustainability":color="#006400";break;case"KTLO":color="#ADFF2F";break;case"Strategic":color="#00FF7F";break;case"User Focused":color="#9ACD32";break;case"Research":color="#66CDAA";break;case"Connectors & On Prem (H1)":color="#20B2AA";break;case"UX":color="#9ACD32";break;case"Initiatives":color="#6495ED";break;case"Defects":color="#CD853F";break;case"Customer Voice":color="#D2691E";break;case"":color="#DCDCDC";break;default:color="#7CFC00"}return color},makeGrid:function(selectedRecords){console.log("records of this category:",selectedRecords),this.down("#piGrid")&&this.down("#gridContainer").remove("piGrid");var gridStore=Ext.create("Rally.data.custom.Store",{data:selectedRecords.records,getGroupString:function(record){var parent=record.get("Parent");return parent&&parent.FormattedID+" "+parent._refObjectName||"No Parent Initiative"},groupField:"Parent",limit:1/0});this.down("#gridContainer").add({xtype:"rallygrid",itemId:"piGrid",store:gridStore,features:[{ftype:"groupingsummary"}],columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name"},{text:"Investment Category",dataIndex:"InvestmentCategory"}]})}});

            Rally.launchApp('CustomApp', {
                name:"Investement Categories",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
